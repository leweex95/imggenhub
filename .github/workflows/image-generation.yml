name: Image generation

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Single prompt for image generation'
        required: true
        default: 'City scene in Budapest with plenty of greenery, micromobility, public terraces, full of life. Highly photorealistic.'
        type: string
      platform:
        description: 'Platform to use for image generation'
        required: false
        default: 'kaggle'
        type: choice
        options:
        - 'kaggle'
      model_name:
        description: 'Hugging Face model to use for generation'
        required: false
        default: 'stabilityai/stable-diffusion-xl-base-1.0'
        type: choice
        options:
        - 'stabilityai/stable-diffusion-xl-base-1.0'
        - 'runwayml/stable-diffusion-v1-5'
        - 'stabilityai/stable-diffusion-2-1'
        - 'CompVis/stable-diffusion-v1-4'
        - 'SG161222/Realistic_Vision_V5.1_noVAE'
      refiner_model_name:
        description: 'Hugging Face refiner model to use (leave empty for default SDXL refiner)'
        required: false
        default: 'stabilityai/stable-diffusion-xl-refiner-1.0'
        type: string
      enable_gpu:
        description: 'Enable GPU for faster generation'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      dest_folder:
        description: 'Destination folder for generated images'
        required: false
        default: 'output_images'
        type: string
      guidance_scale:
        description: 'Guidance scale (7-12 recommended for photorealism)'
        required: false
        default: '10'
        type: string
      inference_steps:
        description: 'Number of inference steps (50-100 for better quality)'
        required: false
        default: '50'
        type: string
      use_refiner:
        description: 'Enable SDXL refiner for enhanced photorealism'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      fp16:
        description: 'Precision level for model weights and inference'
        required: false
        default: 'fp16'
        type: choice
        options:
        - 'fp32'
        - 'fp16'
        - 'int8'
        - 'int4'
      negative_prompt:
        description: 'Custom negative prompt for quality control'
        required: false
        default: 'blurry, low quality, distorted, watermark, duplicate, multiple identical people, clones, repetition, cartoon, anime, painting, drawing, sketch, low resolution, pixelated, noisy, grainy, artifacts, overexposed, underexposed, bad anatomy, deformed, ugly, disfigured'
        type: string

permissions:
  contents: read
  actions: none
  checks: write
  id-token: none

jobs:
  generate-images:
    runs-on: imggenhub-runner
    permissions:
      contents: write
    steps:
      - name: Ensure Bash is available
        shell: powershell
        run: |
          # Check if bash is available
          try {
            $bashPath = Get-Command bash -ErrorAction Stop
            Write-Host "Bash found at: $($bashPath.Source)"
          } catch {
            Write-Host "Bash not found. Installing Git for Windows (which includes Bash)..."
            # Install Git for Windows using Chocolatey (assumes Chocolatey is installed)
            choco install git -y --params "/GitAndUnixToolsOnPath /WindowsTerminal /NoAutoCrlf"
            # Refresh PATH
            $env:PATH = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
            # Verify installation
            try {
              $bashPath = Get-Command bash -ErrorAction Stop
              Write-Host "Bash installed successfully at: $($bashPath.Source)"
            } catch {
              Write-Error "Failed to install Bash. Please install Git for Windows manually on the runner."
              exit 1
            }
          }

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Install Poetry using pip (more reliable than the installer script)
          python -m pip install poetry==2.2.1
          # Add Poetry to PATH
          $poetryPath = python -c "import sys; print(sys.executable.replace('python.exe', 'Scripts'))"
          $env:PATH = "$poetryPath;$env:PATH"
          # Add to GITHUB_PATH for subsequent steps
          echo "$poetryPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          poetry --version

      - name: Install Poetry (Ubuntu)
        if: runner.os != 'Windows'
        uses: snok/install-poetry@v1
        with:
          version: 2.2.1

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          Set-Location "$env:GITHUB_WORKSPACE"
          poetry install --no-interaction
          poetry run pip install kaggle

      - name: Install dependencies (Linux)
        if: runner.os != 'Windows'
        working-directory: ${{ github.workspace }}
        run: |
          poetry install --no-interaction
          poetry run pip install kaggle

      - name: Setup Kaggle credentials (Windows)
        if: runner.os == 'Windows'
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        shell: powershell
        run: |
          $kaggleDir = "$env:USERPROFILE\.kaggle"
          if (!(Test-Path $kaggleDir)) { New-Item -ItemType Directory -Path $kaggleDir | Out-Null }
          $json = "{""username"":""$env:KAGGLE_USERNAME"",""key"":""$env:KAGGLE_KEY""}"
          Set-Content -Path "$kaggleDir\kaggle.json" -Value $json

      - name: Setup Kaggle credentials (Linux)
        if: runner.os != 'Windows'
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          mkdir -p ~/.kaggle
          echo '{"username":"'$KAGGLE_USERNAME'","key":"'$KAGGLE_KEY'"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      - name: Generate images via Kaggle pipeline (Linux)
        if: runner.os != 'Windows'
        env:
          PROMPT: ${{ github.event.inputs.prompt }}
          MODEL_NAME: ${{ github.event.inputs.model_name }}
          REFINER_MODEL_NAME: ${{ github.event.inputs.refiner_model_name }}
          GPU_SETTING: ${{ github.event.inputs.enable_gpu }}
          DEST_FOLDER: ${{ github.event.inputs.dest_folder }}
          TARGET_BRANCH: ${{ github.ref_name }}
          GUIDANCE_SCALE: ${{ github.event.inputs.guidance_scale }}
          INFERENCE_STEPS: ${{ github.event.inputs.inference_steps }}
          USE_REFINER: ${{ github.event.inputs.use_refiner }}
          PRECISION: ${{ github.event.inputs.fp16 }}
          NEGATIVE_PROMPT: ${{ github.event.inputs.negative_prompt }}
        run: |
          echo "Starting image generation with:"
          echo "Prompt: $PROMPT"
          echo "Model: $MODEL_NAME"
          echo "Refiner Model: $REFINER_MODEL_NAME"
          echo "GPU: $GPU_SETTING"
          echo "Destination: $DEST_FOLDER"
          echo "Guidance: $GUIDANCE_SCALE"
          echo "Steps: $INFERENCE_STEPS"
          echo "Use Refiner: $USE_REFINER"
          echo "FP16: $HIGH_QUALITY"
          echo ""
          
          cd src/imggenhub/kaggle
          
          # Build the command with proper arguments
          ARGS="--prompt \"$PROMPT\" --dest ../../../$DEST_FOLDER --guidance $GUIDANCE_SCALE --steps $INFERENCE_STEPS"
          
          if [ "$MODEL_NAME" != "stabilityai/stable-diffusion-xl-base-1.0" ]; then
            ARGS="$ARGS --model_name \"$MODEL_NAME\""
          fi
          
          if [ "$REFINER_MODEL_NAME" != "stabilityai/stable-diffusion-xl-refiner-1.0" ]; then
            ARGS="$ARGS --refiner_model_name \"$REFINER_MODEL_NAME\""
          fi
          
          if [ "$GPU_SETTING" = "true" ]; then
            ARGS="$ARGS --gpu"
          fi
          
          if [ "$USE_REFINER" = "true" ]; then
            ARGS="$ARGS --use_refiner"
          fi
          
          if [ "$HIGH_QUALITY" = "true" ]; then
            ARGS="$ARGS --high_quality"
          fi
          
          if [ -n "$NEGATIVE_PROMPT" ]; then
            ARGS="$ARGS --negative_prompt \"$NEGATIVE_PROMPT\""
          fi
          
          echo "Running: python -m imggenhub.kaggle.main $ARGS"
          echo ""
          
          # Run the full pipeline (deploy -> poll -> download)
          python -c "
          import sys
          import os
          from pathlib import Path
          sys.path.insert(0, os.path.join('..', '..'))
          from imggenhub.kaggle.main import run_pipeline
          
          # Convert shell variables to proper Python types
          gpu_enabled = os.getenv('GPU_SETTING', 'false').lower() == 'true'
          model_name = os.getenv('MODEL_NAME')
          if model_name == 'stabilityai/stable-diffusion-xl-base-1.0':
              model_name = None
          refiner_model_name = os.getenv('REFINER_MODEL_NAME')
          if refiner_model_name == 'stabilityai/stable-diffusion-xl-refiner-1.0':
              refiner_model_name = None
          # Automatically enable refiner if refiner model is specified
          use_refiner = (refiner_model_name is not None)
          precision = os.getenv('PRECISION', 'fp16')
          
          run_pipeline(
              prompts_file=None,
              notebook='config/kaggle-notebook-image-generation.ipynb',
              kernel_path='config',
              gpu=gpu_enabled,
              dest='../../../' + os.getenv('DEST_FOLDER', 'output_images'),
              model_name=model_name,
              refiner_model_name=refiner_model_name,
              prompt=os.getenv('PROMPT'),
              prompts=None,
              guidance=float(os.getenv('GUIDANCE_SCALE', '10')),
              steps=int(os.getenv('INFERENCE_STEPS', '50')),
              precision=precision,
              negative_prompt=os.getenv('NEGATIVE_PROMPT')
          )
          "

      - name: Generate images via Kaggle pipeline (Windows)
        if: runner.os == 'Windows'
        env:
          PROMPT: ${{ github.event.inputs.prompt }}
          MODEL_NAME: ${{ github.event.inputs.model_name }}
          REFINER_MODEL_NAME: ${{ github.event.inputs.refiner_model_name }}
          GPU_SETTING: ${{ github.event.inputs.enable_gpu }}
          DEST_FOLDER: ${{ github.event.inputs.dest_folder }}
          TARGET_BRANCH: ${{ github.ref_name }}
          GUIDANCE_SCALE: ${{ github.event.inputs.guidance_scale }}
          INFERENCE_STEPS: ${{ github.event.inputs.inference_steps }}
          USE_REFINER: ${{ github.event.inputs.use_refiner }}
          PRECISION: ${{ github.event.inputs.fp16 }}
          NEGATIVE_PROMPT: ${{ github.event.inputs.negative_prompt }}
        run: |
          echo "Starting image generation with:"
          echo "Prompt: $env:PROMPT"
          echo "Model: $env:MODEL_NAME"
          echo "Refiner Model: $env:REFINER_MODEL_NAME"
          echo "GPU: $env:GPU_SETTING"
          echo "Destination: $env:DEST_FOLDER"
          echo "Guidance: $env:GUIDANCE_SCALE"
          echo "Steps: $env:INFERENCE_STEPS"
          echo "Use Refiner: $env:USE_REFINER"
          echo "High Quality: $env:HIGH_QUALITY"
          echo ""
          
          cd src/imggenhub/kaggle
          
          # Build the command with proper arguments
          $ARGS = "--prompt `"$env:PROMPT`" --dest ../../../$env:DEST_FOLDER --guidance $env:GUIDANCE_SCALE --steps $env:INFERENCE_STEPS"
          
          if ($env:MODEL_NAME -ne "stabilityai/stable-diffusion-xl-base-1.0") {
            $ARGS += " --model_name `"$env:MODEL_NAME`""
          }
          
          if ($env:REFINER_MODEL_NAME -ne "stabilityai/stable-diffusion-xl-refiner-1.0") {
            $ARGS += " --refiner_model_name `"$env:REFINER_MODEL_NAME`""
          }
          
          if ($env:GPU_SETTING -eq "true") {
            $ARGS += " --gpu"
          }
          
          if ($env:USE_REFINER -eq "true") {
            $ARGS += " --use_refiner"
          }
          
          if ($env:HIGH_QUALITY -eq "true") {
            $ARGS += " --high_quality"
          }
          
          if ($env:NEGATIVE_PROMPT) {
            $ARGS += " --negative_prompt `"$env:NEGATIVE_PROMPT`""
          }
          
          echo "Running: python -m imggenhub.kaggle.main $ARGS"
          echo ""
          
          # Run the full pipeline (deploy -> poll -> download)
          python -c "
          import sys
          import os
          from pathlib import Path
          sys.path.insert(0, os.path.join('..', '..'))
          from imggenhub.kaggle.main import run_pipeline
          
          # Convert shell variables to proper Python types
          gpu_enabled = os.getenv('GPU_SETTING', 'false').lower() == 'true'
          model_name = os.getenv('MODEL_NAME')
          if model_name == 'stabilityai/stable-diffusion-xl-base-1.0':
              model_name = None
          refiner_model_name = os.getenv('REFINER_MODEL_NAME')
          if refiner_model_name == 'stabilityai/stable-diffusion-xl-refiner-1.0':
              refiner_model_name = None
          # Automatically enable refiner if refiner model is specified
          use_refiner = (refiner_model_name is not None)
          precision = os.getenv('PRECISION', 'fp16')
          
          run_pipeline(
              prompts_file=None,
              notebook='config/kaggle-notebook-image-generation.ipynb',
              kernel_path='config',
              gpu=gpu_enabled,
              dest='../../../' + os.getenv('DEST_FOLDER', 'output_images'),
              model_name=model_name,
              refiner_model_name=refiner_model_name,
              prompt=os.getenv('PROMPT'),
              prompts=None,
              guidance=float(os.getenv('GUIDANCE_SCALE', '10')),
              steps=int(os.getenv('INFERENCE_STEPS', '50')),
              precision=precision,
              negative_prompt=os.getenv('NEGATIVE_PROMPT')
          )
          "

      - name: Verify generated images (Linux)
        if: runner.os != 'Windows'
        env:
          DEST_FOLDER: ${{ github.event.inputs.dest_folder }}
        run: |
          echo "Generated images summary:"
          if [ -d "$DEST_FOLDER" ]; then
            IMAGE_COUNT=$(find "$DEST_FOLDER" -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) | wc -l)
            echo "Found $IMAGE_COUNT image(s) in $DEST_FOLDER/"
            
            echo ""
            echo "Files generated:"
            find "$DEST_FOLDER" -type f -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | head -10
            
            # Show total size
            TOTAL_SIZE=$(du -sh "$DEST_FOLDER" | cut -f1)
            echo ""
            echo "Total size: $TOTAL_SIZE"
          else
            echo "No output directory found!"
            exit 1
          fi

      - name: Verify generated images (Windows)
        if: runner.os == 'Windows'
        env:
          DEST_FOLDER: ${{ github.event.inputs.dest_folder }}
        run: |
          echo "Generated images summary:"
          if (Test-Path $env:DEST_FOLDER -PathType Container) {
            $imageFiles = Get-ChildItem -Path $env:DEST_FOLDER -File -Include *.png,*.jpg,*.jpeg -Recurse
            $IMAGE_COUNT = $imageFiles.Count
            echo "Found $IMAGE_COUNT image(s) in $env:DEST_FOLDER/"
            
            echo ""
            echo "Files generated:"
            $imageFiles | Select-Object -First 10 | ForEach-Object { echo $_.FullName }
            
            # Show total size
            $totalSizeBytes = ($imageFiles | Measure-Object -Property Length -Sum).Sum
            $totalSizeMB = [math]::Round($totalSizeBytes / 1MB, 2)
            echo ""
            echo "Total size: $totalSizeMB MB"
          } else {
            echo "No output directory found!"
            exit 1
          }

      - name: Upload generated images as artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-images-${{ github.run_id }}
          path: ${{ github.event.inputs.dest_folder }}/
          retention-days: 7

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Commit and push generated images (Linux)
        if: runner.os != 'Windows'
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          DEST_FOLDER: ${{ github.event.inputs.dest_folder }}
          PROMPT: ${{ github.event.inputs.prompt }}
          MODEL_NAME: ${{ github.event.inputs.model_name }}
          GPU_SETTING: ${{ github.event.inputs.enable_gpu }}
          TARGET_BRANCH: ${{ github.ref_name }}
          GUIDANCE_SCALE: ${{ github.event.inputs.guidance_scale }}
          INFERENCE_STEPS: ${{ github.event.inputs.inference_steps }}
          USE_REFINER: ${{ github.event.inputs.use_refiner }}
          PRECISION: ${{ github.event.inputs.fp16 }}
        run: |
          # Check if there are any images to commit first
          if [ ! -d "$DEST_FOLDER" ] || [ -z "$(find "$DEST_FOLDER" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" 2>/dev/null)" ]; then
            echo "No images found to commit"
            exit 0
          fi
        
          # Always sync with remote first
          git fetch origin
          git reset --hard origin/$TARGET_BRANCH

          # Add generated images to git
          git add "$DEST_FOLDER"
          if git diff --staged --quiet; then
            echo "No new changes to commit"
            exit 0
          fi
          
          git commit -m "[Auto-commit] Added generated images [skip ci]"

          # Push with retries
          RETRIES=5
          for i in $(seq 1 $RETRIES); do
            git push origin $TARGET_BRANCH
            if [ $? -eq 0 ]; then
              echo "Successfully pushed changes."
              exit 0
            else
              echo "Push failed on attempt $i/$RETRIES, retrying..."
              sleep 2
            fi
          done

          echo "Failed to push after $RETRIES attempts."
          exit 1

      - name: Commit and push generated images (Windows)
        if: runner.os == 'Windows'
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          DEST_FOLDER: ${{ github.event.inputs.dest_folder }}
          PROMPT: ${{ github.event.inputs.prompt }}
          MODEL_NAME: ${{ github.event.inputs.model_name }}
          GPU_SETTING: ${{ github.event.inputs.enable_gpu }}
          TARGET_BRANCH: ${{ github.ref_name }}
          GUIDANCE_SCALE: ${{ github.event.inputs.guidance_scale }}
          INFERENCE_STEPS: ${{ github.event.inputs.inference_steps }}
          USE_REFINER: ${{ github.event.inputs.use_refiner }}
          PRECISION: ${{ github.event.inputs.fp16 }}
        run: |
          # Check if there are any images to commit first
          if (-not (Test-Path $env:DEST_FOLDER) -or -not (Get-ChildItem -Path $env:DEST_FOLDER -Include *.png,*.jpg,*.jpeg -Recurse -File)) {
            echo "No images found to commit"
            exit 0
          }
        
          # Always sync with remote first
          git fetch origin
          git reset --hard origin/$env:TARGET_BRANCH

          # Add generated images to git
          git add "$env:DEST_FOLDER"
          if (git diff --staged --quiet) {
            echo "No new changes to commit"
            exit 0
          }
          
          git commit -m "[Auto-commit] Added generated images [skip ci]"

          # Push with retries
          $RETRIES = 5
          for ($i = 1; $i -le $RETRIES; $i++) {
            git push origin $env:TARGET_BRANCH
            if ($LASTEXITCODE -eq 0) {
              echo "Successfully pushed changes."
              exit 0
            } else {
              echo "Push failed on attempt $i/$RETRIES, retrying..."
              Start-Sleep -Seconds 2
            }
          }

          echo "Failed to push after $RETRIES attempts."
          exit 1

  notify:
    needs: generate-images
    if: failure()
    runs-on: imggenhub-runner
    steps:
      - name: Send failure email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸš¨ [ImgGenHub] Image Generation Failed"
          html_body: |
            <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:22px; font-weight:bold; color:red;">
              ðŸš¨ Image Generation Failed!
            </p>
            <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:18px;">
              The image generation workflow failed to complete successfully.
            </p>
            <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:16px;">
              <strong>Generation Details:</strong><br/>
              <strong>Prompt:</strong> ${{ github.event.inputs.prompt }}<br/>
              <strong>Model:</strong> ${{ github.event.inputs.model_name }}<br/>
              <strong>Refiner Model:</strong> ${{ github.event.inputs.refiner_model_name }}<br/>
              <strong>GPU:</strong> ${{ github.event.inputs.enable_gpu }}<br/>
              <strong>Guidance Scale:</strong> ${{ github.event.inputs.guidance_scale }}<br/>
              <strong>Inference Steps:</strong> ${{ github.event.inputs.inference_steps }}<br/>
              <strong>Use Refiner:</strong> ${{ github.event.inputs.use_refiner }}<br/>
              <strong>Precision:</strong> ${{ github.event.inputs.fp16 }}<br/>
              <strong>Destination:</strong> ${{ github.event.inputs.dest_folder }}
            </p>
            <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:18px;">
              Check logs: <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">Workflow Run</a>
            </p>
            <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:18px;">
              <strong>Debug Artifacts:</strong><br/>
              <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts">All Artifacts</a>
            </p>
          to: ${{ secrets.EMAIL_USERNAME }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
