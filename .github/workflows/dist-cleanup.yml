name: Distribution cleanup

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

permissions:
  contents: read
  actions: none
  checks: write
  id-token: none

jobs:
  cleanup-dist:
    runs-on: imggenhub-runner
    steps:
      - name: Ensure Bash is available
        shell: powershell
        run: |
          # Check if bash is available
          try {
            $bashPath = Get-Command bash -ErrorAction Stop
            Write-Host "Bash found at: $($bashPath.Source)"
          } catch {
            Write-Host "Bash not found. Installing Git for Windows (which includes Bash)..."
            # Install Git for Windows using Chocolatey (assumes Chocolatey is installed)
            choco install git -y --params "/GitAndUnixToolsOnPath /WindowsTerminal /NoAutoCrlf"
            # Refresh PATH
            $env:PATH = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
            # Verify installation
            try {
              $bashPath = Get-Command bash -ErrorAction Stop
              Write-Host "Bash installed successfully at: $($bashPath.Source)"
            } catch {
              Write-Error "Failed to install Bash. Please install Git for Windows manually on the runner."
              exit 1
            }
          }

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cleanup old dist files
        shell: bash
        run: |
          cd dist
          for tag in $(git tag --sort=-creatordate); do
              files=( *${tag}* )
              if [ ${#files[@]} -gt 1 ]; then
                  # keep newest, delete older
                  newest="${files[-1]}"
                  for f in "${files[@]}"; do
                      if [ "$f" != "$newest" ]; then
                          rm "$f"
                      fi
                  done
              fi
          done
          cd ..

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Commit and push changes
        shell: bash
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Always sync with remote first
          git fetch origin master
          git reset --hard origin/master

          # Stage and commit if there are changes
          git add dist
          if ! git diff --quiet --cached; then
            git commit -m "[Auto-commit] Distribution cleanup [skip ci]"
          fi

          # Push with retries, but fail if never succeeds
          RETRIES=10
          for i in $(seq 1 $RETRIES); do
            if git push https://x-access-token:$PAT_TOKEN@github.com/${{ github.repository }} HEAD:master; then
              echo "Successfully pushed changes."
              exit 0
            else
              echo "Push failed, retrying ($i/$RETRIES)..."
              sleep 3
            fi
          done

          echo "Push failed after $RETRIES attempts."
          exit 1
